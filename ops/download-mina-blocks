#!/bin/sh

set -x
set -eu

RESULT='Failure'
exit_handler() {
  echo "${RESULT}. Exiting." >&2
}
trap exit_handler EXIT

MY_DIR="$(CDPATH= cd "$(dirname "$0")" && pwd)"

# Wrap s3cmd.
s3c() {
  time \
    s3cmd \
    -c "$MY_DIR"/s3cfg \
    --access_key="$LINODE_OBJ_ACCESS_KEY" \
    --secret_key="$LINODE_OBJ_SECRET_KEY" \
    "$@"
}

# Verify that we can connect.
s3c ls

# Download the Mina blocks logs from the Granola bucket. Note that "$1" is the
# order of magnitude of the block count. So, "3" gets blocks of height up to
# 99, and "5" gets blocks of height up to 99,999. "$2" is the destination
# directory.
s3c sync --rexclude 'mainnet-\d{'"$1"',}-.*' s3://granola-mina-blocks "$2"

RESULT='Success'
