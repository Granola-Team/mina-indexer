steps:

- label: "Developer Environment Build and Test"
  key: build
  command: |
    echo HOME=$HOME
    echo PATH=$PATH
    nix develop --command just
    nix develop --command just prereqs
    nix develop --command just test

- label: "Tier 2 Testing"
  key: tier2
  if: build.branch == "main" && build.env('GRANOLA_NIGHTLY_BUILD') == "true"
  timeout_in_minutes: 2880
  depends_on:
  - build
  agents:
    mina-log-storage: true
    docker: true
  command: |
    nix develop --command just build
    nix develop --command tests/regression test_many_blocks
    # TODO: why is this not working?
    # nix develop --command tests/regression test_release
    ops/ingest-all
    nix develop --command ops/test-justfile-targets

- label: "Create OCI Image"
  key: image
  if: build.branch == "main"
  depends_on:
  - tier2
  agents:
    docker: true
  command: |
    nix build .#dockerImage
    docker load < ./result
    docker run --rm -it \
      mina-indexer:"$(git rev-parse --short=9 HEAD)" \
        mina-indexer server start --help
    docker image rm mina-indexer:"$(git rev-parse --short=9 HEAD)"

