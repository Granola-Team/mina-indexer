steps:

- label: "Build and Test"
  command: |
    echo HOME=$HOME
    echo PATH=$PATH
    nix develop --command just
    nix develop --command just prereqs
    nix develop --command just test-ci | tee build.log
  key: build
  artifact_paths: "build.log"
  env:
    CARGO_INCREMENTAL: 0
  agents:
    os: linux

- label: "Create OCI Image"
  command: |
    nix build .#dockerImage
    docker load < ./result
    docker run --rm -it \
      mina-indexer:"$(git rev-parse --short=9 HEAD)" \
        mina-indexer server start --help
    docker image rm mina-indexer:"$(git rev-parse --short=9 HEAD)"
  key: image
  agents:
    docker: true
