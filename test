#!/bin/sh
set -ex

mkdir -p $TMP/blocks
cleanup() {
    echo "Exiting with $?"
    rm -rf $TMP/blocks
    kill $(pgrep mina-indexer)
}
trap cleanup EXIT

# cargo fmt --check
# cargo check
# cargo audit -D unmaintained -D yanked
# cargo clippy
cargo build
# cargo nextest run

DOMAIN_SOCKET=/var/run/mina-indexer.sock

shutdown() {
    echo "shutdown\0" | nc -U $DOMAIN_SOCKET
}

account_balance() {
    echo "account $1\0" | nc -U $DOMAIN_SOCKET | jq .balance
}

best_ledger() {
    echo "best-ledger\0" | nc -U $DOMAIN_SOCKET | jq .ledger
}

summary() {
    echo "summary\0" | nc -U $DOMAIN_SOCKET | jq .summary
}

idxr() { 
    ./target/debug/mina-indexer "$@" 
}

server() {
    ./target/debug/mina-indexer server "$@"
}

client() {
    ./target/debug/mina-indexer client "$@"
}

dl() {
    BUCKET=$1; MAX_SLOT=$2; NETWORK=$3; OUT_DIR=$4
    ./download_blocks $BUCKET $MAX_SLOT $NETWORK $OUT_DIR
}

dl_mainnet() {
    MAX_SLOT=$1; OUT_DIR=$2
    ./download_blocks mina_network_block_data $MAX_SLOT mainnet $OUT_DIR
}

dl_berkeley() {
    MAX_SLOT=$1; OUT_DIR=$2
    ./download_blocks mina_network_block_data $MAX_SLOT berkeley $OUT_DIR
}

# Indexer reports usage with no arguments
idxr 2>&1 | 
    grep -iq "Usage:"

# Indexer reports usage for server subcommand
idxr server 2>&1 |
    grep -iq "Usage: mina-indexer server"

# Indexer reports usage for client subcommand
idxr client 2>&1 | 
    grep -iq "Usage: mina-indexer client"

# Indexer server config subcommand exists
idxr server config 2>&1 | 
    grep -iq "Usage: mina-indexer server config"

# Indexer server cli subcommand works
idxr server cli --help > /dev/null

# Indexer server config passes cli with minimal args
idxr server cli \
    --initial-ledger tests/ledgers/mainnet-genesis.json \
    --is-genesis-ledger \
    --root-hash 3NKeMoncuHab5ScarV5ViyF16cJPT4taWNSaTLS64Dp67wuXigPZ &
IDXR_PID=$(pgrep mina-indexer)
kill $IDXR_PID

# Indexer server starts up on a minimal selection of blocks
dl_mainnet 15 $TMP/blocks
server cli \
    --startup-dir $TMP/blocks \
    --watch-dir $TMP/blocks \
    --initial-ledger tests/ledgers/mainnet-genesis.json \
    --is-genesis-ledger \
    --root-hash 3NKeMoncuHab5ScarV5ViyF16cJPT4taWNSaTLS64Dp67wuXigPZ &
IDXR_PID=$(pgrep mina-indexer)
sleep 2
echo $(client -o summary -v) |
    jq .witness_tree.canonical_tip_hash | 
    grep -iq "3NKQUoBfi9vkbuqtDJmSEYBQrcSo4GjwG8bPCiii4yqM8AxEQvtY"
kill $IDXR_PID

# Indexer server ipc is available during initialization
dl_mainnet 250 $TMP/blocks
server cli \
    --startup-dir $TMP/blocks \
    --watch-dir $TMP/blocks \
    --initial-ledger tests/ledgers/mainnet-genesis.json \
    --is-genesis-ledger \
    --root-hash 3NKeMoncuHab5ScarV5ViyF16cJPT4taWNSaTLS64Dp67wuXigPZ &
IDXR_PID=$(pgrep mina-indexer)
sleep 3
echo $(client -o summary -v) |
    jq .witness_tree.canonical_tip_hash | 
    grep -iq "3NKeMoncuHab5ScarV5ViyF16cJPT4taWNSaTLS64Dp67wuXigPZ"
kill $IDXR_PID

echo "Done"